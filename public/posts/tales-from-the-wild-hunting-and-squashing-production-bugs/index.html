<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Hunting Production Bugs | Ahmad's Log</title><meta name=keywords content="software"><meta name=description content="Usually, on boarding in a new job passes in a slow rhythm during the first couple of months. That was the case with me at least, getting to know how our infrastructure at Runtastic is built.."><meta name=author content="Ahmad Tolba"><link rel=canonical href=https://ahmgeek.com/posts/tales-from-the-wild-hunting-and-squashing-production-bugs/><link crossorigin=anonymous href=/assets/css/stylesheet.ab70943e643097269cab2754fa3a9dbe4a10d33f078c00a2159b711a3ad4be96.css integrity="sha256-q3CUPmQwlyacqydU+jqdvkoQ0z8HjACiFZtxGjrUvpY=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://ahmgeek.com/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://ahmgeek.com/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://ahmgeek.com/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://ahmgeek.com/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://ahmgeek.com/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-41805436-4","auto"),ga("send","pageview"))</script><meta property="og:title" content="Hunting Production Bugs"><meta property="og:description" content="Usually, on boarding in a new job passes in a slow rhythm during the first couple of months. That was the case with me at least, getting to know how our infrastructure at Runtastic is built.."><meta property="og:type" content="article"><meta property="og:url" content="https://ahmgeek.com/posts/tales-from-the-wild-hunting-and-squashing-production-bugs/"><meta property="og:image" content="https://ahmgeek.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-05-09T14:33:00+00:00"><meta property="article:modified_time" content="2018-05-09T14:33:00+00:00"><meta property="og:site_name" content="Ahmad's Log"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://ahmgeek.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Hunting Production Bugs"><meta name=twitter:description content="Usually, on boarding in a new job passes in a slow rhythm during the first couple of months. That was the case with me at least, getting to know how our infrastructure at Runtastic is built.."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://ahmgeek.com/posts/"},{"@type":"ListItem","position":3,"name":"Hunting Production Bugs","item":"https://ahmgeek.com/posts/tales-from-the-wild-hunting-and-squashing-production-bugs/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Hunting Production Bugs","name":"Hunting Production Bugs","description":"Usually, on boarding in a new job passes in a slow rhythm during the first couple of months. That was the case with me at least, getting to know how our infrastructure at Runtastic is built..","keywords":["software"],"articleBody":" Originally written for: Runtastic’s tech blog\nHOW DOES IT BEGIN? Usually, on boarding in a new job passes in a slow rhythm during the first couple of months. That was the case with me at least, getting to know how our infrastructure at Runtastic is built, how the services interact with each other, how to monitor services you are responsible for, reading the guidelines, etc.\nShortly after I joined, I got to build a prototype with one of my new teammates. We were on track, and we got to monitor a release of a new service within our team’s responsibilities; we got a quick training on how to monitor the release and what numbers we need to look at. We knew what to do, as the knowledge transferred a couple of days before the release, and everything was good to go.\nAnd technically speaking, the release performed well internally and for some trusted users a couple of weeks before the shout out and telling the public, so no problems were expected.\nThe morning of the release was fun. I had just arrived at my desk and my colleague said, “The workers are down.”\nTHE FIRST TALE: KNOW YOUR LIMITS We run our microservices with jRuby. It’s efficient, and we have real threading. We also use Sidekiq with Redis for running background jobs. I tell you this, because it’s important to know the potential impact of the stack you use.\nBasically, we had increasing numbers of the dead jobs set in our workers servers.\nWe also have an automatic mechanism to shut down the workers if the dead set reached specific limits; Sidekiq has a (default) limit of 10,000 jobs which can be stored as dead jobs. A dead job is a job that exceeds its retry limit and is not configured to skip the dead jobs queue.\nWhen reaching the limit, jobs are lost, hence the mechanism:\nsidekiq_retries_exhausted do |msg| if Sidekiq::DeadSet.new.size \u003e (Sidekiq.options[:dead_max_jobs] - DEAD_JOBS_THRESHOLD) Sidekiq::CLI.instance.launcher.quiet end end And we ended up with a non-working service with a dead set full of jobs with “too many open files” errors.\nFor that error to show up, you could have hit the limit imposed by your OS for the file descriptors, or maybe the limit itself is a bit low during your server provisioning phase. Also the process of your web server could be behaving weirdly.\nulimit -a is a *nix tool, which could help you identify most of the resources’ limits in your box.\nWe need the file descriptor one – ulimit -n– which gives you the limit of open files in your machine.\nIt turned out we have a high number of open files across all of the processes. We also used lsof to see how many files our server process opens:\nlsof | awk '{ print $2; }' | uniq -c | sort -rn | head\nI will let you find out what this command does as homework – feel free to leave a comment about it.\nAs the number of open files was really high, we were looking into the file manipulation we do in our service more closely:\nYou can use File.open in ruby in two ways: with a block or without it.\nFile.open('foo', 'w') do |file| # Do stuff with file file.write \"bar\" end file = File.open('foo', 'w') # Do stuff with file file.write \"bar\" file.close It turned out we used the latter, where we should close the file after reading it ourselves. We closed the file, but if an exception happens before we close the file, it will remain open.\nSo we added an ensure clause:\ndef method file = File.open(foo, 'w+') # Processing and stuff ensure file.close end After patching and closing the files properly and communicating with the OPS team to increase the limits in our servers, the issue came back the next day.\nAt this point, we revised most of the code we open files in and tried to see what’s wrong there, but we found nothing.\nIT’S ALWAYS IN THE LOGS A temporary fix was to monitor when we reach the file limits and restart the process. This worked until we figured out the issue.\nThe next morning I opened New Relic and tried to trace the error one more time. Hidden between the stack trace there was a line from a third party library.\nWe used an unofficial gem (shareable libraries are called “gems” in the ruby world) to manipulate vendor specific XML files, because the official SDK for working with these XML files was written in Java.\nIt turned out that the unofficial gem opened the files, did some processing, and closed the files, but again, if something failed in between, it would remain open.\nI patched a fork of the gem and deployed it and also pointed out this issue to the maintainer so he could fix it.\nThe open files error didn’t show up as quickly as before. Thankfully my teammate focused on speeding up finalization of the gem we are building (a ruby wrapper around the official SDK) and we had it done quickly. We replaced the old gem with it, and we have never been happier.\nTHE SECOND TALE, WHERE’S MY DATA? One day someone approached our desks and said, “I noticed something weird, I did some running sessions yesterday and tracked it with my smartwatch, but some sessions were missing.”\nThis was related somehow with the release we did, the service basically worked as an importer for the XML files from the watches and supported hardware into our system. So when you have a sports session, you could find it under your Runtastic account, if you connected them, of course.\nI consider myself a Rubyist; I use ruby as my main language because I love it, I read about “_why the lucky stiff” and knew lots of what was in the community even before becoming part of it. I know that ruby has no real threads because of the GIL thingy. Before even starting using the language, I never had to worry about the threading issue before and was happy using MRI anyway, but now this haunted me.\nFrom the figure above, you get a general overview of how jRuby has a real threading model. So if you use jRuby, you need to make sure your code is thread-safe, otherwise you will have a pleasant time debugging weird errors.\njRuby by default ensures the standard libraries are thread-safe for you. After a bit of investigation, I found we silence_stream used from active_support, which is not thread-safe. I removed it. We also tried to revise most of the code to make sure we are not abusing memoization or += incrementers as most of these are not thread safe. The real issue is we don’t use threaded code, so this bug comes from a hidden place. Also reproducing a bug like this locally is really hard; as you know, thread-safe bugs are pain in the ass.\nWe went deeper to know where the places are which we could put shared data between threads and tried to do some tests for the new gem we built. Since it’s a wrapper around a Java SDK, which acts as a black box to us, we wanted to make sure the issue doesn’t come from there first.\nCOUNTDOWNLATCH AS A TESTING MECHANISM One of our architects suggested using CountDownLatch for testing the gem thread-safeness.\nThe idea was simple: I start reading files inside a thread and before processing the files, I latch the thread. I do the same in a second thread. Then I countdown and let the threads race to process the files.\nrequire \"concurrent\" it \"is a thread-safe\" do latch = Concurrent::CountDownLatch.new(1) sample_1_records = nil sample_2_records = nil t1 = Thread.new do file = nil File.open(\"./spec/xml_samples/sample1.xml\") do |f| latch.wait file = XmlDecoder::Reader.new(f.to_inputstream).read end sample_1_records = file.sessions.last.records end t2 = Thread.new do file = nil File.open(\"./spec/xml_samples/sample2.xml\") do |f| latch.wait file = XmlDecoder::Reader.new(f.to_inputstream).read end sample_2_records = file.sessions.last.records end latch.count_down t1.join t2.join expect(sample_1_records.size).to eq(2518) expect(sample_1_records.last.altitude).to eq(2242.800048828125) expect(sample_2_records.size).to eq(406) expect(sample_2_records.last.cadence).to eq(76) end I got unstable results, which means the gem has a thread-safe bug. Looking quickly into the code we found that we used instance variables inside modules, which means they are module variables and shared between threads.\nmodule XmlDecoder def self.read(inputstream) # Not so good. @activity = Activity.new end end module XmlDecoder def self.read(inputstream) activity = Activity.new end end That went off our radars, so we quickly bumped the gem and deployed it. And we are back to being happy again**.**\nTHE THIRD TALE, PATCHING PRODUCTION CODE, OR HOW I STOPPED WORRYING AND LET IT GO No matter what, production has its own rules. We always act like we don’t patch directly on production, always hot fixing code instead. We talk about best practices, reproduce it locally first. We shun those who say they don’t actually follow the rules, while in critical situations, you really need to act quickly and sometimes stop the bleeding first before it can heal.\nOne day, we merged a Pull Request and deployed it to production, but all of our servers couldn’t get up. Workers were down, servers were down. It was weird that the PR and tests passed the CI and most of the environments, but failed on production, which should be no surprise within the wild and harsh land of production.\nGetting into the server and trying to read the logs, the error was mentioning a model we’d never had a problem with before. I commented out a suspicious line within that file, restarted the server, and the process came up; The line was basically just re-defining an already defined dry-struct object. With dry-struct, if you initialize struct attributes, you can’t define it or alter it anymore. It’s immutable and this is why we use it.\nRemoving that line fixed the issue. For some reason, the error was tolerant in CI and testing environments and just showed the error in console, which for some reason got swallowed. Tests were passing, which just caused a fatal error in production.\nWorking with assumptions on production is a bad way to mitigate an issue, but in the wonderland of production you might compromise a little bit to get stuff working until the main fix lands. You need to stop the bleed before healing in a clean way.\nYou also need some luck; trust me.\n","wordCount":"1728","inLanguage":"en","datePublished":"2018-05-09T14:33:00Z","dateModified":"2018-05-09T14:33:00Z","author":{"@type":"Person","name":"Ahmad Tolba"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ahmgeek.com/posts/tales-from-the-wild-hunting-and-squashing-production-bugs/"},"publisher":{"@type":"Organization","name":"Ahmad's Log","logo":{"@type":"ImageObject","url":"https://ahmgeek.com/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ahmgeek.com accesskey=h title="Ahmad's Log (Alt + H)"><img src=https://ahmgeek.com/apple-touch-icon.png alt aria-label=logo height=35>Ahmad's Log</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://ahmgeek.com/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://ahmgeek.com/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://ahmgeek.com/search title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://ahmgeek.com/tags title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Hunting Production Bugs</h1><div class=post-meta><span title='2018-05-09 14:33:00 +0000 UTC'>May 9, 2018</span>&nbsp;·&nbsp;9 min&nbsp;·&nbsp;Ahmad Tolba</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#how-does-it-begin><strong>HOW DOES IT BEGIN?</strong></a></li><li><a href=#the-first-tale-know-your-limits><strong>THE FIRST TALE: KNOW YOUR LIMITS</strong></a></li><li><a href=#its-always-in-the-logs><strong>IT’S ALWAYS IN THE LOGS</strong></a></li><li><a href=#the-second-tale-wheres-my-data><strong>THE SECOND TALE, WHERE’S MY DATA?</strong></a></li><li><a href=#countdownlatch-as-a-testing-mechanism><strong>COUNTDOWNLATCH AS A TESTING MECHANISM</strong></a></li><li><a href=#the-third-tale-patching-production-code-or-how-i-stopped-worrying-and-let-it-go><strong>THE THIRD TALE, PATCHING PRODUCTION CODE, OR HOW I STOPPED WORRYING AND LET IT GO</strong></a></li></ul></nav></div></details></div><div class=post-content><blockquote><p>Originally written for: <a href=https://www.runtastic.com/blog/en/tracing-and-fixing-bugs>Runtastic&rsquo;s tech blog</a></p></blockquote><h2 id=how-does-it-begin><strong>HOW DOES IT BEGIN?</strong><a hidden class=anchor aria-hidden=true href=#how-does-it-begin>#</a></h2><p>Usually, on boarding in a new job passes in a slow rhythm during the first couple of months. That was the case with me at least, getting to know how our infrastructure at Runtastic is built, how the services interact with each other, how to monitor services you are responsible for, reading the guidelines, etc.</p><p>Shortly after I joined, I got to build a prototype with one of my new teammates. We were on track, and we got to monitor a release of a new service within our team’s responsibilities; we got a quick training on how to monitor the release and what numbers we need to look at. We knew what to do, as the knowledge transferred a couple of days before the release, and everything was good to go.</p><p>And technically speaking, the release performed well internally and for some trusted users a couple of weeks before the shout out and telling the public, so no problems were expected.</p><p>The morning of the release was fun. I had just arrived at my desk and my colleague said, “The workers are down.”</p><h2 id=the-first-tale-know-your-limits><strong>THE FIRST TALE: KNOW YOUR LIMITS</strong><a hidden class=anchor aria-hidden=true href=#the-first-tale-know-your-limits>#</a></h2><p>We run our microservices with jRuby. It’s efficient, and we have real threading. We also use Sidekiq with Redis for running background jobs. I tell you this, because it’s important to know the potential impact of the stack you use.</p><p>Basically, we had increasing numbers of the dead jobs set in our workers servers.</p><p>We also have an automatic mechanism to shut down the workers if the dead set reached specific limits; Sidekiq has a (default) limit of 10,000 jobs which can be stored as dead jobs. A dead job is a job that exceeds its retry limit and is not configured to skip the dead jobs queue.</p><p>When reaching the limit, <a href=https://github.com/mperham/sidekiq/wiki/Error-Handling#dead-job-queue>jobs are lost</a>, hence the mechanism:</p><pre tabindex=0><code>sidekiq_retries_exhausted do |msg|
  if Sidekiq::DeadSet.new.size &gt; (Sidekiq.options[:dead_max_jobs] - DEAD_JOBS_THRESHOLD)
    Sidekiq::CLI.instance.launcher.quiet
  end
end
</code></pre><p>And we ended up with a non-working service with a dead set full of jobs with “too many open files” errors.</p><p>For that error to show up, you could have hit the limit imposed by your OS for the file descriptors, or maybe the limit itself is a bit low during your server provisioning phase. Also the process of your web server could be behaving weirdly.</p><p><code>ulimit -a</code> is a *nix tool, which could help you identify most of the resources’ limits in your box.</p><p>We need the file descriptor one – <code>ulimit -n</code>– which gives you the limit of open files in your machine.</p><p>It turned out we have a high number of open files across all of the processes. We also used <code>lsof</code> to see how many files our server process opens:</p><p><code>lsof | awk '{ print $2; }' | uniq -c | sort -rn | head</code></p><p>I will let you find out what this command does as homework – feel free to leave a comment about it.</p><p>As the number of open files was really high, we were looking into the file manipulation we do in our service more closely:</p><p>You can use <code>File.open</code> in ruby in two ways: with a block or without it.</p><pre tabindex=0><code>File.open(&#39;foo&#39;, &#39;w&#39;) do |file|
  # Do stuff with file
  file.write &#34;bar&#34;
end
file = File.open(&#39;foo&#39;, &#39;w&#39;)
# Do stuff with file
file.write &#34;bar&#34;
file.close
</code></pre><p>It turned out we used the latter, where we should close the file after reading it ourselves. We closed the file, but if an exception happens before we close the file, it will remain open.</p><p>So we added an ensure clause:</p><pre tabindex=0><code>def method  
  file = File.open(foo, &#39;w+&#39;)
  # Processing and stuff
ensure
  file.close
end
</code></pre><p>After patching and closing the files properly and communicating with the OPS team to increase the limits in our servers, the issue came back the next day.</p><p>At this point, we revised most of the code we open files in and tried to see what’s wrong there, but we found nothing.</p><h2 id=its-always-in-the-logs><strong>IT’S ALWAYS IN THE LOGS</strong><a hidden class=anchor aria-hidden=true href=#its-always-in-the-logs>#</a></h2><p>A temporary fix was to monitor when we reach the file limits and restart the process. This worked until we figured out the issue.</p><p>The next morning I opened New Relic and tried to trace the error one more time. Hidden between the stack trace there was a line from a third party library.</p><p>We used an unofficial gem (shareable libraries are called “gems” in the ruby world) to manipulate vendor specific XML files, because the official SDK for working with these XML files was written in Java.</p><p>It turned out that the unofficial gem opened the files, did some processing, and closed the files, but again, if something failed in between, it would remain open.</p><p>I patched a fork of the gem and deployed it and also <a href=https://github.com/scrapper/fit4ruby/commit/2cf7800b75d74e3b7b15b4aadc738bebcdca121f>pointed out this issue</a> to the maintainer so he could fix it.</p><p>The open files error didn’t show up as quickly as before. Thankfully my teammate focused on speeding up finalization of the gem we are building (a ruby wrapper around the official SDK) and we had it done quickly. We replaced the old gem with it, and we have never been happier.</p><h2 id=the-second-tale-wheres-my-data><strong>THE SECOND TALE, WHERE’S MY DATA?</strong><a hidden class=anchor aria-hidden=true href=#the-second-tale-wheres-my-data>#</a></h2><p>One day someone approached our desks and said, “I noticed something weird, I did some running sessions yesterday and tracked it with my smartwatch, but some sessions were missing.”</p><p>This was related somehow with the release we did, the service basically worked as an importer for the XML files from the watches and supported hardware into our system. So when you have a sports session, you could find it under your Runtastic account, if you connected them, of course.</p><p>I consider myself a Rubyist; I use ruby as my main language because I love it, I read about “_why the lucky stiff” and knew lots of what was in the community even before becoming part of it. I know that ruby has no real threads because of the GIL thingy. Before even starting using the language, I never had to worry about the threading issue before and was happy using MRI anyway, but now this haunted me.</p><p><img loading=lazy src=/ruby_version.png alt=figure-1></p><p>From the figure above, you get a general overview of how jRuby has a real threading model. So if you use jRuby, you need to make sure your code is thread-safe, otherwise you will have a pleasant time debugging weird errors.</p><p>jRuby by default ensures the standard libraries are thread-safe for you. After a bit of investigation, I found we <code>silence_stream</code> used from <code>active_support</code>, which is not thread-safe. I removed it. We also tried to revise most of the code to make sure we are not abusing memoization or <code>+=</code> incrementers as most of these are not thread safe. The real issue is we don’t use threaded code, so this bug comes from a hidden place. Also reproducing a bug like this locally is really hard; as you know, thread-safe bugs are pain in the ass.</p><p>We went deeper to know where the places are which we could put shared data between threads and tried to do some tests for the new gem we built. Since it’s a wrapper around a Java SDK, which acts as a black box to us, we wanted to make sure the issue doesn’t come from there first.</p><h2 id=countdownlatch-as-a-testing-mechanism><strong>COUNTDOWNLATCH AS A TESTING MECHANISM</strong><a hidden class=anchor aria-hidden=true href=#countdownlatch-as-a-testing-mechanism>#</a></h2><p>One of our architects suggested using <a href=http://ruby-concurrency.github.io/concurrent-ruby/Concurrent/CountDownLatch.html>CountDownLatch</a> for testing the gem thread-safeness.</p><p>The idea was simple: I start reading files inside a thread and before processing the files, I latch the thread. I do the same in a second thread. Then I countdown and let the threads race to process the files.</p><pre tabindex=0><code>require &#34;concurrent&#34;
  it &#34;is a thread-safe&#34; do
    latch = Concurrent::CountDownLatch.new(1)
    sample_1_records = nil
    sample_2_records = nil
    t1 = Thread.new do
      file = nil
      File.open(&#34;./spec/xml_samples/sample1.xml&#34;) do |f|
        latch.wait
        file = XmlDecoder::Reader.new(f.to_inputstream).read
      end
      sample_1_records = file.sessions.last.records
    end
    t2 = Thread.new do
      file = nil
      File.open(&#34;./spec/xml_samples/sample2.xml&#34;) do |f|
        latch.wait
        file = XmlDecoder::Reader.new(f.to_inputstream).read
      end
      sample_2_records = file.sessions.last.records
    end
    latch.count_down
    t1.join
    t2.join
    expect(sample_1_records.size).to eq(2518)
    expect(sample_1_records.last.altitude).to eq(2242.800048828125)
    expect(sample_2_records.size).to eq(406)
    expect(sample_2_records.last.cadence).to eq(76)
  end
</code></pre><p>I got unstable results, which means the gem has a thread-safe bug. Looking quickly into the code we found that we used instance variables inside modules, which means they are module variables and shared between threads.</p><pre tabindex=0><code>module XmlDecoder
  def self.read(inputstream)
    # Not so good.
    @activity = Activity.new
  end
end
module XmlDecoder
  def self.read(inputstream)
    activity = Activity.new
  end
end
</code></pre><p>That went off our radars, so we quickly bumped the gem and deployed it. And we are back to being happy again**.**</p><h2 id=the-third-tale-patching-production-code-or-how-i-stopped-worrying-and-let-it-go><strong>THE THIRD TALE, PATCHING PRODUCTION CODE, OR HOW I STOPPED WORRYING AND LET IT GO</strong><a hidden class=anchor aria-hidden=true href=#the-third-tale-patching-production-code-or-how-i-stopped-worrying-and-let-it-go>#</a></h2><p>No matter what, production has its own rules. We always act like we <a href="https://www.youtube.com/watch?v=v77FFbQwC6E&feature=youtu.be&t=736">don’t patch directly on production</a>, always hot fixing code instead. We talk about best practices, reproduce it locally first. We shun those who say they don’t actually follow the rules, while in critical situations, you really need to act quickly and sometimes stop the bleeding first before it can heal.</p><p>One day, we merged a Pull Request and deployed it to production, but all of our servers couldn’t get up. Workers were down, servers were down. It was weird that the PR and tests passed the CI and most of the environments, but failed on production, which should be no surprise within the wild and harsh land of production.</p><p>Getting into the server and trying to read the logs, the error was mentioning a model we’d never had a problem with before. I commented out a suspicious line within that file, restarted the server, and the process came up; The line was basically just re-defining an already defined <a href=https://github.com/dry-rb/dry-struct>dry-struct</a> object. With dry-struct, if you initialize struct attributes, you can’t define it or alter it anymore. It’s immutable and this is why we use it.</p><p>Removing that line fixed the issue. For some reason, the error was tolerant in CI and testing environments and just showed the error in console, which for some reason got swallowed. Tests were passing, which just caused a fatal error in production.</p><p>Working with assumptions on production is a bad way to mitigate an issue, but in the wonderland of production you might compromise a little bit to get stuff working until the main fix lands. You need to stop the bleed before healing in a clean way.</p><p>You also need some luck; trust me.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://ahmgeek.com/tags/software/>software</a></li></ul><nav class=paginav><a class=prev href=https://ahmgeek.com/posts/my-2020-in-books/><span class=title>«</span><br><span>My 2020 in books</span></a>
<a class=next href=https://ahmgeek.com/posts/a-journey-from-acceptability-to-habituality/><span class=title>»</span><br><span>A journey from Acceptability to habituality</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Hunting Production Bugs on twitter" href="https://twitter.com/intent/tweet/?text=Hunting%20Production%20Bugs&url=https%3a%2f%2fahmgeek.com%2fposts%2ftales-from-the-wild-hunting-and-squashing-production-bugs%2f&hashtags=software"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Hunting Production Bugs on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fahmgeek.com%2fposts%2ftales-from-the-wild-hunting-and-squashing-production-bugs%2f&title=Hunting%20Production%20Bugs&summary=Hunting%20Production%20Bugs&source=https%3a%2f%2fahmgeek.com%2fposts%2ftales-from-the-wild-hunting-and-squashing-production-bugs%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Hunting Production Bugs on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fahmgeek.com%2fposts%2ftales-from-the-wild-hunting-and-squashing-production-bugs%2f&title=Hunting%20Production%20Bugs"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Hunting Production Bugs on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fahmgeek.com%2fposts%2ftales-from-the-wild-hunting-and-squashing-production-bugs%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Hunting Production Bugs on whatsapp" href="https://api.whatsapp.com/send?text=Hunting%20Production%20Bugs%20-%20https%3a%2f%2fahmgeek.com%2fposts%2ftales-from-the-wild-hunting-and-squashing-production-bugs%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Hunting Production Bugs on telegram" href="https://telegram.me/share/url?text=Hunting%20Production%20Bugs&url=https%3a%2f%2fahmgeek.com%2fposts%2ftales-from-the-wild-hunting-and-squashing-production-bugs%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://ahmgeek.com>Ahmad's Log</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>